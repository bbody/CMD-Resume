language: node_js
node_js:
- '8'
dist: trusty
before_script:
- npm install -g gulp-cli
script:
- gulp test:karma
cache:
  directories:
  - node_modules
env:
- CXX=g++-4.8 CC=gcc-4.8
branches:
  except:
  - /^v?\d+\.\d+\.\d+$/
addons:
  - apt:
    sources:
    - ubuntu-toolchain-r-test
    packages:
    - g++-4.8
  - code_climate
  - chrome: stable
before_deploy:
- gulp release
- gulp build-gh-pages
before_install:
  # Create a git tag of the new version to use
  # If package.json major and minor versions match last tag, then increment last tag. Else use package.json major.minor.0.
- "{ sed -nE 's/^[ \\t]*\"version\": \"([0-9]{1,}\\.[0-9]{1,}\\.)[0-9x]{1,}\",$/\\1/p' package.json; git describe --abbrev=0 | sed -E 's/^v([0-9]{1,}\\.[0-9]{1,}\\.)([0-9]{1,})$/\\1 \\2/g'; } | tr \"\\n\" \" \" | awk '{printf($1==$2?\"v\"$2$3+1:\"v\"$1\"0\")}' | xargs -I {} git tag -a {} -m \"{}\"\n"
  # Update package.json based on the git tag we just created
- npm --no-git-tag-version version from-git
deploy:
  - provider: script
    skip_cleanup: true
    script:
    - git config --global user.email "travis@travis-ci.org"
    - git config --global user.name "Travis CI"
    - git remote rm origin
    - git remote add origin https://bbody:${GITHUB_TOKEN}@github.com/bbody/CMD-Resume.git
    - git push --tags
    on:
      branch: master
  - provider: releases
    skip_cleanup: true
    api_key: $GITHUB_TOKEN
    file:
      - "./dist/cmd-resume.js"
      - "./dist/cmd-resume.min.js"
    on:
      repo: bbody/CMD-Resume
      tags: true
      branch: master
  - provider: pages
    skip_cleanup: true
    local_dir: ./tmp
    github_token: $GITHUB_TOKEN
    target_branch: gh-pages
    fqdn: cmd-resume.bbody.io
    repo: bbody/CMD-Resume
    on:
      branch: master
  - provider: npm
    email: "bbody.project@gmail.com"
    api_key: $NPMJS_TOKEN
after_success:
  - npm install -g codeclimate-test-reporter
  - codeclimate-test-reporter < coverage/lcov.info
